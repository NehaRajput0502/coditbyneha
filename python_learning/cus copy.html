<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HHRESVW2T1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HHRESVW2T1');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Our Valued Customers - Duke Jia</title>
  <meta name="description" content="Sales & service for embroidery, perforation and quilting machines across India. DUKEJIA by HCA - Delhi, Chennai, Bengaluru, Kolkata, Indore, Ludhiana, Tiruppur."/>
  <link rel="canonical" href="https://dukejia.com/Customers-Details.html">
  <meta name="robots" content="index,follow"/>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Icons / Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --pur:#045285;
      --pur2:#833ade;
      --muted:#5f6970;
      --muted2:#6f7a82;
      --lgray:#E8EDF2;
      --bg:#FAF9F6;
      --text:#2D3436;
      --primary:var(--pur2);
      --accent:#A29BFE;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .container{margin:0 auto;padding:0 40px}
    @media (max-width:1024px){.container{padding:0 24px}}
    @media (max-width:480px){.container{padding:0 16px}}

    /* Header */
    .site-header {
      position: sticky; top: 0; z-index: 50;
      background: rgba(250, 249, 246, 0.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--lgray);
    }
    .container.nav {
      display: flex; justify-content: space-between; align-items: center;
      height: 72px;
    }
    .nav-center { display:flex; gap:28px; align-items:center; }
    .nav-center a { color: var(--text); font-weight: 600; }
    .nav-center a:hover { color: var(--pur2); }
    .btn-quote{
      display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;
      font-weight:700;background:linear-gradient(90deg,var(--accent),var(--pur2));
      color:#3a2b00;
    }
    .menu-toggle { display:none; background:none; border:none; color:var(--pur); font-size:1.5rem; cursor:pointer; padding:8px; border-radius:6px; }
    @media (max-width:780px){
      .nav-center{
        position:fixed; top:72px; left:0; right:0;
        background: rgba(250, 249, 246, 0.98);
        backdrop-filter: blur(10px);
        flex-direction:column; padding:20px 24px; gap:0;
        transform: translateY(-100%); opacity:0; visibility:hidden;
        transition:0.3s; border-bottom:1px solid var(--lgray);
      }
      .nav-center.open{ transform:translateY(0); opacity:1; visibility:visible; }
      .nav-center a{ padding:16px 0; width:100%; border-bottom:1px solid #eee; }
      .nav-center a:last-child{ border-bottom:none; }
      .menu-toggle{ display:block; }
      .btn-quote{ width:100%; justify-content:center; }
    }

    /* Hero */
    .hero{
      background-image: radial-gradient(1100px 520px at 80% -10%, rgba(168, 139, 255, 0.18), transparent 60%),
                       radial-gradient(900px 450px at -10% 90%, rgba(4, 82, 133, 0.12), transparent 60%);
      background-attachment: fixed;
      padding: 60px 0 20px;
    }
    .headline{ font-size: clamp(2.2rem, 5vw, 3.6rem); line-height:1.05; margin:0 0 1rem; font-weight:900; color:var(--pur); }
    .headline .accent{ color:transparent; background: linear-gradient(90deg, var(--pur), var(--pur2)); -webkit-background-clip:text; background-clip:text; }
    .sub{ font-size: clamp(1.05rem, 1.7vw, 1.2rem); line-height: 1.8; color:#4a5258; max-width: 100ch; margin:0; }

    /* Filters */
    .filters-bar{ display:flex; gap:16px; align-items:flex-end; margin-top:4px; margin-bottom:10px; flex-wrap:wrap; }
    .filter-group{ display:flex; flex-direction:column; gap:6px; min-width:180px; }
    .filter-group.wide{ flex:1; min-width:240px; }
    .filter-group label{ font-size:.85rem; font-weight:600; color:var(--muted2); }
    .filter-group select, .filter-group input{
      padding:8px 10px; border-radius:10px; border:1px solid var(--lgray);
      font:inherit; outline:none; background:#fff;
    }

    .view-toggle{ display:flex; margin-left:auto; gap:0; align-items:center; }
    .view-toggle button{
      padding:10px 18px; border:1px solid var(--lgray); background:#fff;
      color:var(--text); font-weight:600; cursor:pointer; transition:all .3s ease; height:38px;
    }
    .view-toggle button:first-child{ border-radius:10px 0 0 10px; }
    .view-toggle button:last-child{ border-radius:0 10px 10px 0; }
    .view-toggle button.active{ background:var(--primary); color:#fff; border-color:var(--primary); }

    @media (max-width:640px){
      .filters-bar{ flex-direction:column; align-items:stretch; }
      .view-toggle{ flex-direction:column; margin-left:0; margin-top:8px; width:100%; align-items:stretch; }
      .view-toggle button{ border-radius:10px !important; margin-bottom:10px; width:100%; }
    }

    /* Map */
    .map-section{ display:none; padding:20px 0 60px; }
    .map-section.active{ display:block; }
    .map-layout{ display:grid; grid-template-columns:1fr 1fr; gap:30px; align-items:stretch; }
    .map-side{ display:flex; flex-direction:column; gap:20px; }
    .map-container{ height:500px; border-radius:20px; overflow:hidden; border:1px solid var(--lgray); }
    .state-selector{ display:flex; flex-wrap:wrap; gap:10px; }
    .state-btn{
      padding:8px 16px; border:1px solid var(--lgray); border-radius:20px;
      background:#fff; color:var(--text); font-weight:600; cursor:pointer; transition:all .3s ease;
    }
    .state-btn.active{ background:var(--primary); color:#fff; border-color:var(--primary); }

    .cards-side{
      display:flex; flex-direction:column; gap:14px;
      min-height:520px; height:100%;
      background:#fff; border:1px solid var(--lgray);
      border-radius:20px; padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    .cards-title{ margin:0; font-size:1.4rem; font-weight:800; color:var(--pur); }
    .cards-grid{
      display:grid; grid-template-columns:1fr; gap:16px;
      max-height:460px; overflow-y:auto; padding-right:10px;
      background:#fff;
    }
    @media (max-width:1024px){
      .map-layout{ grid-template-columns:1fr; gap:20px; }
      .cards-grid{ max-height:none; }
    }

    /* Cards */
    .customer-card{
      background:#fff; border:1px solid var(--lgray);
      border-radius:20px; overflow:hidden;
      transition:all .25s ease; position:relative;
      display:flex; flex-direction:column;
    }
    .customer-card:hover{ transform: translateY(-6px); border-color: rgba(4,82,133,.20); }
    .customer-header{ padding:18px 18px 0; display:flex; align-items:flex-start; gap:12px; }
    .customer-logo{
      width:60px; height:60px; border-radius:12px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900; font-size:1.2rem; flex-shrink:0;
    }
    .customer-info{ flex:1; min-width:0; }

    /* NAME ROW + EYE */
    .name-row{
      display:flex; align-items:center; gap:10px;
      justify-content:space-between;
    }
    .customer-name{
      font-size:1.15rem; font-weight:900; margin:0 0 4px; color:var(--pur);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .masked-name{
      letter-spacing: .08em;
      font-weight: 900;
    }
    .eye-btn{
      width:36px; height:36px;
      border-radius:10px; border:1px solid var(--lgray);
      background:#fff; color:var(--muted);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:all .2s ease;
      flex-shrink:0;
    }
    .eye-btn:hover{ background:var(--primary); color:#fff; border-color:var(--primary); transform:scale(1.05); }

    .customer-location{ display:flex; align-items:center; gap:6px; color:var(--muted); font-size:.9rem; margin-bottom:8px; }
    .customer-body{ padding:14px 18px; }
    .detail-item{ display:flex; align-items:center; gap:8px; color:var(--muted2); font-size:.9rem; margin:8px 0; }
    .detail-item i{ width:16px; color:var(--pur); }

    .customer-footer{
      padding:14px 18px 18px; border-top:1px solid var(--lgray);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .customer-model{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; border-radius:20px;
      background:#ffebeb; color:#FF0000; font-weight:800; font-size:.85rem;
      cursor:pointer;
    }

    /* Customers section */
    .customers-section{ padding: 10px 0 60px; }
    .customers-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:18px; }

    @media (max-width:640px){
      .customers-grid{ grid-template-columns:1fr; }
    }

    /* Modal */
    .modal{
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,.55); z-index:2000;
      align-items:center; justify-content:center;
    }
    .modal.active{ display:flex; }
    .modal-content{
      background:#fff; border-radius:18px;
      width:92%; max-width:620px;
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
      overflow:hidden;
    }
    .modal-header{
      display:flex; justify-content:space-between; align-items:center;
      padding:18px 20px; border-bottom:1px solid var(--lgray);
    }
    .modal-title{ margin:0; font-size:1.35rem; font-weight:900; color:var(--pur); }
    .modal-close{ background:none; border:none; font-size:1.6rem; cursor:pointer; color:var(--muted); }
    .modal-body{ padding:18px 20px; }
    .modal-actions{ display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; }

    .modal-btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 16px; border-radius:10px; border:1px solid var(--lgray);
      background:#fff; color:var(--text); font-weight:800; cursor:pointer;
    }
    .modal-btn.primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
    .modal-btn.primary:hover{ background:var(--accent); border-color:var(--accent); }

    .input{
      width:100%; padding:10px 12px; border:1px solid var(--lgray);
      border-radius:10px; font:inherit; outline:none;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:640px){ .grid2{ grid-template-columns:1fr; } }

    .small-note{ margin:10px 0 0; color:var(--muted2); font-size:13px; line-height:1.5; }

    /* Footer (same as yours, shortened a bit) */
    .site-footer{padding:28px 24px;border-top:1px solid var(--lgray);color:#e7f1ff;background:var(--pur)}
    .footer-grid{display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:40px}
    .footer-brand{margin:0 0 10px;font-size:36px;font-weight:900;background:linear-gradient(90deg,#ffffff,#98D8C8);-webkit-background-clip:text;background-clip:text;color:transparent;}
    .footer-links h4,.footer-contact h4{margin:0 0 12px;color:#fff;font-size:22px}
    .footer-links ul{list-style:none;padding:0;margin:0}
    .footer-links li{margin:10px 0}
    .footer-links a{color:#e7f1ff}
    .foot-divider{height:1px;background:rgba(255,255,255,.18);margin:28px 0 14px}
    .foot-bottom{display:flex;align-items:center;justify-content:space-between;gap:16px;color:#d9e7ff;font-size:14px}
    @media (max-width:980px){.footer-grid{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.footer-grid{grid-template-columns:1fr}.foot-bottom{flex-direction:column;align-items:flex-start;gap:8px}}
  </style>
</head>

<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container nav">
      <a class="brand" href="index.html" aria-label="Duke Jia Home">
        <span><img src="images/dukejia.png" width="190" height="55" alt="DUKEJIA" loading="lazy"></span>
      </a>
      <button class="menu-toggle" aria-label="Toggle navigation"><i class="fa-solid fa-bars"></i></button>
      <nav class="nav-center" aria-label="Primary">
        <a href="index.html">Home</a>
        <a href="Products-Details.html">Products</a>
        <a href="Customers-Details.html" style="color: var(--pur2); font-weight:700;">Our Customers</a>
        <a href="Contact.html">Contact</a>
        <a class="btn-quote"
          href="https://wa.me/919350513789?text=Hi%20Duke%20Jia%20Team%2C%20I%27m%20interested%20in%20your%20machines.%20Please%20share%20pricing%20%26%20availability."
          target="_blank" rel="noopener">
          <i class="fa-solid fa-phone"></i> Get Quote</a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="container hero-inner">
      <h1 class="headline">Our <span class="accent">Valued Customers</span></h1>
      <p class="sub">Discover textile manufacturers across India who trust Duke Jia's & Duke's embroidery and perforation technology.</p>
    </div>
  </section>

  <!-- Filters -->
  <div class="container filters-bar">
    <div class="filter-group">
      <label for="areaFilter">Area</label>
      <select id="areaFilter"><option value="all">All Areas</option></select>
    </div>

    <div class="filter-group wide">
      <label for="customerSearch">Customer / City / Model</label>
      <input type="text" id="customerSearch" placeholder="Search by customer, city or machine model..." />
    </div>

    <div class="view-toggle">
      <button id="mapViewBtn" class="active"><i class="fa-solid fa-grip"></i> Map View</button>
      <button id="cardViewBtn"><i class="fa-solid fa-map"></i> Card View</button>
    </div>
  </div>

  <!-- Customers Grid -->
  <section class="customers-section" id="customersSection">
    <div class="container">
      <div class="customers-grid" id="customer-gallery"></div>
    </div>
  </section>

  <!-- Map Section -->
  <section class="map-section" id="mapSection">
    <div class="container">
      <div class="map-layout">
        <div class="map-side">
          <div class="state-selector" id="stateSelector">
            <button class="state-btn active" data-region="all">All Regions</button>
            <button class="state-btn" data-region="NCR">NCR</button>
            <button class="state-btn" data-region="East">East India</button>
            <button class="state-btn" data-region="North">North India</button>
            <button class="state-btn" data-region="West">West India</button>
            <button class="state-btn" data-region="South">South India</button>
          </div>
          <div class="map-container" id="map" style="position: sticky; top: 90px;"></div>
        </div>

        <div class="cards-side">
          <h3 class="cards-title">Customers in <span id="currentRegion">All Regions</span></h3>
          <div class="cards-grid" id="map-customer-gallery"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
       LEAD FORM MODAL (STEP 1)
       ========================= -->
  <div class="modal" id="leadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">View Customer Name</h2>
        <button class="modal-close" id="leadClose">&times;</button>
      </div>
      <div class="modal-body">
        <p class="small-note" style="margin-top:0">
          Fill details to unlock request. After submit we will open WhatsApp. <b>Wait 15‚Äì20 minutes</b>, we will share username & password on WhatsApp.
        </p>

        <form id="leadForm" autocomplete="on">
          <input type="hidden" id="lf_customerId">
          <input type="hidden" id="lf_customerName">

          <div class="grid2">
            <input class="input" id="lf_userName" placeholder="Your Name *" required>
            <input class="input" id="lf_mobile" placeholder="Mobile No. *" required inputmode="numeric">
          </div>

          <div style="margin-top:10px">
            <input class="input" id="lf_company" placeholder="Company Name *" required>
          </div>

          <div style="margin-top:10px">
            <input class="input" id="lf_email" placeholder="Email (optional)" type="email">
          </div>

          <div style="margin-top:10px">
            <input class="input" id="lf_requirement" placeholder="Requirement (Quote / Demo / Service)">
          </div>

          <label style="display:flex;gap:8px;align-items:flex-start;margin-top:10px;font-size:13px;color:var(--muted2);">
            <input type="checkbox" id="lf_consent" required>
            <span>I agree DukeJia / HCA may contact me regarding my enquiry.</span>
          </label>

          <div class="modal-actions">
            <button class="modal-btn primary" id="lf_submit" type="submit">
              <i class="fa-brands fa-whatsapp"></i> Unlock Request & Open WhatsApp
            </button>
            <button class="modal-btn" id="lf_cancel" type="button">Cancel</button>
          </div>

          <div id="lf_msg" class="small-note"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- =========================
       ACCESS MODAL (STEP 2)
       ========================= -->
  <div class="modal" id="accessModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Enter Username & Password</h2>
        <button class="modal-close" id="accessClose">&times;</button>
      </div>
      <div class="modal-body">
        <p class="small-note" style="margin-top:0">
          If you already received username/password on WhatsApp, enter it here.
          Names will be visible for <b>20 minutes</b>.
        </p>

        <form id="accessForm" autocomplete="off">
          <div class="grid2">
            <input class="input" id="acc_user" placeholder="Username *" required>
            <input class="input" id="acc_pass" placeholder="Password *" type="password" required>
          </div>

          <div class="modal-actions">
            <button class="modal-btn primary" type="submit">
              <i class="fa-solid fa-unlock"></i> Unlock Names
            </button>
            <button class="modal-btn" id="accessCancel" type="button">Cancel</button>
          </div>

          <div id="acc_msg" class="small-note"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h3 class="footer-brand">Duke Jia</h3>
        <p style="margin:0;color:#e7f1ff">Trusted by manufacturers across India.</p>
      </div>
      <div class="footer-links">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="About.html">About Us</a></li>
          <li><a href="Products-Details.html">Our Machines</a></li>
          <li><a href="Customers-Details.html">Customer Stories</a></li>
          <li><a href="Contact.html">Service &amp; Support</a></li>
        </ul>
      </div>
      <div class="footer-contact">
        <h4>Contact</h4>
        <div style="margin:10px 0">üìû +91 9350513789</div>
        <div style="margin:10px 0">‚úâÔ∏è embroidery@grouphca.com</div>
      </div>
    </div>
    <div class="container foot-divider"></div>
    <div class="container foot-bottom">
      <div>¬© <span id="year"></span> Duke Jia ‚Äì Part of Jia Group. All rights reserved.</div>
      <div></div>
    </div>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ==============================
       CONFIG
    ============================== */
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOKkU2SvoTI9FbNVCI_aDmwA_sabwwbGWI51B9sNqTYmWv6I2-xz4fbWzMlQyblvO7/exec";
    const WHATSAPP_NUMBER = "919350513789";

    // You will share these on WhatsApp manually after 15‚Äì20 minutes
    // Change these anytime (daily/weekly).
    const ACCESS_USERNAME = "DUKEJIA";     // <-- set your username
    const ACCESS_PASSWORD = "12345";       // <-- set your password

    // Unlock duration
    const UNLOCK_MINUTES = 20;

    // localStorage keys
    const UNLOCK_KEY = "dukejia_unlock_v1";
    const LEAD_KEY   = "dukejia_lead_submitted_v1";
    const LEAD_EXPIRE_MIN = 30;

    /* ==============================
       HELPERS
    ============================== */
    function now(){ return Date.now(); }

    function setUnlock(minutes){
      localStorage.setItem(UNLOCK_KEY, JSON.stringify({ ts: now(), min: minutes }));
    }
    function isUnlocked(){
      try{
        const raw = localStorage.getItem(UNLOCK_KEY);
        if(!raw) return false;
        const obj = JSON.parse(raw);
        const age = now() - Number(obj.ts || 0);
        const max = Number(obj.min || UNLOCK_MINUTES) * 60 * 1000;
        if(age > max){
          localStorage.removeItem(UNLOCK_KEY);
          return false;
        }
        return true;
      }catch(e){ return false; }
    }

    function setLeadSubmitted(){
      localStorage.setItem(LEAD_KEY, JSON.stringify({ ts: now() }));
    }
    function hasRecentLead(){
      try{
        const raw = localStorage.getItem(LEAD_KEY);
        if(!raw) return false;
        const obj = JSON.parse(raw);
        const age = now() - Number(obj.ts || 0);
        const max = LEAD_EXPIRE_MIN * 60 * 1000;
        if(age > max){
          localStorage.removeItem(LEAD_KEY);
          return false;
        }
        return true;
      }catch(e){ return false; }
    }

    function getInitials(name=""){
      return name.split(" ").filter(Boolean).map(w=>w[0]).join("").substring(0,3).toUpperCase();
    }

    function maskName(name=""){
      const clean = (name || "").trim();
      if(!clean) return "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      const first = clean[0].toUpperCase();
      return first + "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
    }

    function customerDisplayName(c){
      return isUnlocked() ? (c.name || "-") : maskName(c.name || "");
    }

    /* ==============================
       MOBILE NAV
    ============================== */
    const menuToggle = document.querySelector('.menu-toggle');
    const navCenter  = document.querySelector('.nav-center');
    if (menuToggle && navCenter) {
      const icon = menuToggle.querySelector("i");
      menuToggle.addEventListener("click", () => {
        navCenter.classList.toggle("open");
        const open = navCenter.classList.contains("open");
        icon.classList.toggle("fa-xmark", open);
        icon.classList.toggle("fa-bars", !open);
      });
      document.querySelectorAll(".nav-center a").forEach(a => {
        a.addEventListener("click", () => {
          navCenter.classList.remove("open");
          icon.classList.remove("fa-xmark");
          icon.classList.add("fa-bars");
        });
      });
    }

    /* ==============================
       LOAD CUSTOMERS
    ============================== */
    let CUSTOMERS = [];

    const gallery          = document.getElementById("customer-gallery");
    const mapGallery       = document.getElementById("map-customer-gallery");
    const mapViewBtn       = document.getElementById("mapViewBtn");
    const cardViewBtn      = document.getElementById("cardViewBtn");
    const customersSection = document.getElementById("customersSection");
    const mapSection       = document.getElementById("mapSection");
    const stateButtons     = document.querySelectorAll(".state-btn");
    const currentRegion    = document.getElementById("currentRegion");
    const areaFilter       = document.getElementById("areaFilter");
    const customerSearch   = document.getElementById("customerSearch");

    let currentArea = "all";
    let searchQuery = "";
    let currentMapRegion = "all";

    // map
    let map;
    let markers = [];

    async function loadCustomers(){
      try{
        const res = await fetch('data/customers.json', { cache: 'no-store' });
        if(!res.ok) throw new Error("Failed to load customers.json");
        const data = await res.json();
        const raw = Array.isArray(data) ? data : (data.customers || []);
        CUSTOMERS = raw.map(c => ({ area:"", ...c, brand: c.brand || "Duke Jia", area: c.area || "" }));
        initFilterOptions();
        renderCustomers();
      }catch(err){
        console.error(err);
        if(gallery) gallery.innerHTML = `<div style="padding:30px;color:#666">Unable to load customers.</div>`;
      }
    }

    function initFilterOptions(){
      const set = new Set();
      CUSTOMERS.forEach(c => { if(c.area) set.add(c.area); });
      areaFilter.innerHTML = `<option value="all">All Areas</option>`;
      Array.from(set).sort().forEach(a=>{
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        areaFilter.appendChild(opt);
      });
    }

    function getFilteredCustomers(){
      const q = (searchQuery || "").trim().toLowerCase();
      return CUSTOMERS.filter(c=>{
        const regionMatch = currentMapRegion === "all" || c.region === currentMapRegion;
        const areaMatch = currentArea === "all" || (c.area && c.area === currentArea);
        const searchMatch =
          !q ||
          (c.name && c.name.toLowerCase().includes(q)) ||
          (c.city && c.city.toLowerCase().includes(q)) ||
          (c.model && c.model.toLowerCase().includes(q));
        return regionMatch && areaMatch && searchMatch;
      });
    }

    function normalizeLatLng(coord){
      if(!Array.isArray(coord) || coord.length !== 2) return null;
      let a = Number(coord[0]);
      let b = Number(coord[1]);
      if(!Number.isFinite(a) || !Number.isFinite(b)) return null;
      const looksSwapped = Math.abs(a) > 90 && Math.abs(b) <= 90;
      if(looksSwapped) [a,b] = [b,a];
      if(Math.abs(a) > 90 || Math.abs(b) > 180) return null;
      return [a,b];
    }

    function initMap(){
      map = L.map("map").setView([22.9, 78.5], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);
      updateMapMarkers();
    }

    function refreshMapSize(){
      if(!map) return;
      setTimeout(()=>map.invalidateSize(true), 50);
    }

    function getMachineCountForCustomer(customer){
      return CUSTOMERS.filter(c =>
        c.name === customer.name &&
        c.city === customer.city &&
        (c.area || "") === (customer.area || "")
      ).length;
    }

    function updateMapMarkers(){
      if(!map) return;

      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const filtered = getFilteredCustomers();
      filtered.forEach(c=>{
        const latlng = normalizeLatLng(c.coord);
        if(!latlng) return;

        const machineCount = getMachineCountForCustomer(c);
        const titleName = customerDisplayName(c);

        const marker = L.marker(latlng).addTo(map).bindPopup(`
          <div style="min-width:220px;">
            <h3 style="margin:0 0 6px;">${titleName}</h3>
            <p style="margin:0 0 6px;"><strong>Location:</strong> ${c.city}${c.area ? " ("+c.area+")" : ""}</p>
            <p style="margin:0 0 6px;"><strong>Model:</strong> ${c.model}</p>
            <p style="margin:0 0 8px;"><strong>Machines installed:</strong> ${machineCount}</p>
            <button style="padding:7px 12px;background:#833ade;color:#fff;border:none;border-radius:8px;cursor:pointer;"
              onclick="event.stopPropagation();onEyeClick(${c.id})">
              <i class="fa-solid fa-eye"></i> View Name
            </button>
          </div>
        `);
        markers.push(marker);
      });

      if(markers.length === 0){
        map.setView([22.9, 78.5], 5);
        return;
      }
      const group = new L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.15));
    }

    function renderCustomers(){
      const filtered = getFilteredCustomers();
      currentRegion.textContent = (currentMapRegion === "all") ? "All Regions" : currentMapRegion;
      renderCustomerCards(gallery, filtered);
      renderCustomerCards(mapGallery, filtered);
      if(map){
        updateMapMarkers();
        refreshMapSize();
      }
    }

    function renderCustomerCards(container, customers){
      if(!container) return;
      container.innerHTML = "";

      customers.forEach((c, i)=>{
        const card = document.createElement("div");
        card.className = "customer-card";
        const displayName = customerDisplayName(c);
        const isMasked = !isUnlocked();

        card.innerHTML = `
          <div class="customer-header">
            <div class="customer-logo">${getInitials(c.name)}</div>
            <div class="customer-info">
              <div class="name-row">
                <h3 class="customer-name ${isMasked ? "masked-name" : ""}" title="${isMasked ? "Hidden" : (c.name || "")}">
                  ${displayName}
                </h3>
                <button class="eye-btn" type="button" data-eye="${c.id}" title="View customer name">
                  <i class="fa-solid ${isMasked ? "fa-eye" : "fa-eye-slash"}"></i>
                </button>
              </div>
              <div class="customer-location"><i class="fas fa-map-marker-alt"></i>${c.city || ""}</div>
            </div>
          </div>

          <div class="customer-body">
            <div class="detail-item"><i class="fas fa-industry"></i>${c.brand || "Duke Jia"}</div>
            <div class="detail-item"><i class="fas fa-tag"></i>${c.model || ""}</div>
            <div class="detail-item"><i class="fas fa-map"></i>${c.region || ""} Region${c.area ? " ‚Ä¢ " + c.area : ""}</div>
          </div>

          <div class="customer-footer">
            <div class="customer-model video-btn" data-video="${c.youtubeId || ""}">
              <i class="fa-brands fa-youtube"></i> Watch Video
            </div>
            <button class="modal-btn" type="button" data-eye2="${c.id}">
              <i class="fa-solid fa-eye"></i> View Name
            </button>
          </div>
        `;
        container.appendChild(card);
      });

      // Eye clicks
      container.querySelectorAll("[data-eye],[data-eye2]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = Number(btn.getAttribute("data-eye") || btn.getAttribute("data-eye2"));
          onEyeClick(id);
        });
      });

      // video
      container.querySelectorAll(".video-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.video;
          if(!id) return alert("No video available.");
          window.open(`https://www.youtube.com/watch?v=${id}`, "_blank");
        });
      });
    }

    /* ==============================
       VIEW SWITCH
    ============================== */
    function switchView(v){
      if(v === "card"){
        mapSection.style.display = "none";
        customersSection.style.display = "block";
        cardViewBtn.classList.add("active");
        mapViewBtn.classList.remove("active");
      }else{
        customersSection.style.display = "none";
        mapSection.style.display = "block";
        mapViewBtn.classList.add("active");
        cardViewBtn.classList.remove("active");
        if(!map) initMap();
        refreshMapSize();
      }
    }

    mapViewBtn.addEventListener("click", ()=>switchView("map"));
    cardViewBtn.addEventListener("click", ()=>switchView("card"));

    stateButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        currentMapRegion = btn.dataset.region;
        stateButtons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        renderCustomers();
      });
    });

    areaFilter.addEventListener("change", e=>{
      currentArea = e.target.value;
      renderCustomers();
    });

    customerSearch.addEventListener("input", e=>{
      searchQuery = e.target.value;
      renderCustomers();
    });

    document.getElementById("year").textContent = new Date().getFullYear();

    /* ==============================
       STEP FLOW (EYE CLICK)
    ============================== */
    const leadModal    = document.getElementById("leadModal");
    const leadClose    = document.getElementById("leadClose");
    const leadForm     = document.getElementById("leadForm");
    const lf_cancel    = document.getElementById("lf_cancel");
    const lf_submit    = document.getElementById("lf_submit");
    const lf_msg       = document.getElementById("lf_msg");

    const accessModal  = document.getElementById("accessModal");
    const accessClose  = document.getElementById("accessClose");
    const accessCancel = document.getElementById("accessCancel");
    const accessForm   = document.getElementById("accessForm");
    const acc_msg      = document.getElementById("acc_msg");

    let pendingCustomerId = null;

    window.onEyeClick = function(customerId){
      pendingCustomerId = Number(customerId);

      // If already unlocked -> just refresh UI (names visible)
      if(isUnlocked()){
        renderCustomers();
        return;
      }

      // If lead submitted recently -> show ACCESS modal (enter user/pass)
      if(hasRecentLead()){
        openAccessModal();
        return;
      }

      // Otherwise show lead form first
      openLeadModal(pendingCustomerId);
    };

    function openLeadModal(customerId){
      const cust = CUSTOMERS.find(x => Number(x.id) === Number(customerId));
      document.getElementById("lf_customerId").value = String(customerId || "");
      document.getElementById("lf_customerName").value = cust ? (cust.name || "") : "";

      lf_msg.textContent = "";
      leadForm.reset();
      // restore hidden after reset
      document.getElementById("lf_customerId").value = String(customerId || "");
      document.getElementById("lf_customerName").value = cust ? (cust.name || "") : "";

      leadModal.classList.add("active");
      document.body.style.overflow = "hidden";
    }
    function closeLeadModal(){
      leadModal.classList.remove("active");
      document.body.style.overflow = "auto";
    }

    function openAccessModal(){
      acc_msg.textContent = "";
      accessForm.reset();
      accessModal.classList.add("active");
      document.body.style.overflow = "hidden";
    }
    function closeAccessModal(){
      accessModal.classList.remove("active");
      document.body.style.overflow = "auto";
    }

    leadClose.addEventListener("click", closeLeadModal);
    lf_cancel.addEventListener("click", closeLeadModal);

    accessClose.addEventListener("click", closeAccessModal);
    accessCancel.addEventListener("click", closeAccessModal);

    leadModal.addEventListener("click", (e)=>{ if(e.target === leadModal) closeLeadModal(); });
    accessModal.addEventListener("click", (e)=>{ if(e.target === accessModal) closeAccessModal(); });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        if(leadModal.classList.contains("active")) closeLeadModal();
        if(accessModal.classList.contains("active")) closeAccessModal();
      }
    });

    /* ==============================
       LEAD SUBMIT (SAVE + WHATSAPP + ALERT)
    ============================== */
    leadForm.addEventListener("submit", async (e)=>{
      e.preventDefault();

      const mobile = document.getElementById("lf_mobile").value.trim();
      if(!/^\d{10}$/.test(mobile)){
        lf_msg.textContent = "Please enter a valid 10-digit mobile number.";
        return;
      }
      if(!document.getElementById("lf_consent").checked){
        lf_msg.textContent = "Please tick consent.";
        return;
      }

      const cust = CUSTOMERS.find(x => Number(x.id) === Number(pendingCustomerId)) || {};
      const payload = {
        customerId: String(pendingCustomerId || ""),
        customerName: cust.name || "",
        userName: document.getElementById("lf_userName").value.trim(),
        mobile,
        company: document.getElementById("lf_company").value.trim(),
        email: document.getElementById("lf_email").value.trim(),
        requirement: document.getElementById("lf_requirement").value.trim(),
        city: cust.city || "",
        model: cust.model || "",
        region: cust.region || "",
        area: cust.area || "",
        consent: true,
        page: location.href,
        userAgent: navigator.userAgent
      };

      lf_submit.disabled = true;
      lf_msg.textContent = "Submitting...";

      try{
        // save to sheet (no-cors ok)
        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        // mark lead submitted (so next click shows access modal)
        setLeadSubmitted();

        // open WhatsApp with message
        const msg =
`Hi DukeJia Team,
I want to view customer names on your website.

My Details:
Name: ${payload.userName}
Mobile: ${payload.mobile}
Company: ${payload.company}
Email: ${payload.email || "-"}
Requirement: ${payload.requirement || "-"}

Please share username/password to unlock customer names.`;

        const wa = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
        window.open(wa, "_blank");

        closeLeadModal();

        // REQUIRED ALERT
        alert("‚úÖ Request submitted.\n\nPlease wait 15‚Äì20 minutes.\nWe will share username & password on WhatsApp.\nThen click eye again and enter username/password to view customer names.");

        // After alert, show access modal immediately (optional)
        // User can close it and come later.
        openAccessModal();

      }catch(err){
        lf_msg.textContent = "Submit failed: " + (err?.message || err);
      }finally{
        lf_submit.disabled = false;
      }
    });

    /* ==============================
       ACCESS FORM SUBMIT (CLIENT CHECK)
    ============================== */
    accessForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const u = (document.getElementById("acc_user").value || "").trim();
      const p = (document.getElementById("acc_pass").value || "").trim();

      if(u === ACCESS_USERNAME && p === ACCESS_PASSWORD){
        setUnlock(UNLOCK_MINUTES);
        closeAccessModal();
        renderCustomers();
        alert("‚úÖ Unlocked! Customer names are visible for 20 minutes.");
      }else{
        acc_msg.textContent = "‚ùå Incorrect username or password. Please check WhatsApp message and try again.";
      }
    });

    /* ==============================
       INITIAL LOAD
    ============================== */
    switchView("map");
    loadCustomers();
  </script>
</body>
</html>
